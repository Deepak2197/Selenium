name: DAMS Automation CI/CD Pipeline

on:
  # Run on push to main branch
  push:
    branches: [ main, master ]
  
  # Run on pull requests
  pull_request:
    branches: [ main, master ]
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run on schedule (every day at 9 AM UTC)
  schedule:
    - cron: '0 9 * * *'

jobs:
  dams-automation:
    runs-on: ubuntu-latest
    
    steps:
      # ========================================
      # STEP 1: Checkout Repository
      # ========================================
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      # ========================================
      # STEP 2: Setup Java 17
      # ========================================
      - name: ‚òï Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
      
      # ========================================
      # STEP 3: Setup Chrome & ChromeDriver
      # ========================================
      - name: üåê Setup Chrome Browser
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
      
      - name: üöó Setup ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      - name: üìã Verify Chrome & ChromeDriver Installation
        run: |
          echo "Chrome version:"
          google-chrome --version
          echo "ChromeDriver version:"
          chromedriver --version
      
      # ========================================
      # STEP 4: Cache Maven Dependencies
      # ========================================
      - name: üì¶ Cache Maven Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      # ========================================
      # STEP 5: Build Project with Maven
      # ========================================
      - name: üî® Build with Maven
        run: |
          echo "Building project..."
          mvn clean compile -DskipTests
      
      # ========================================
      # STEP 6: Run Automation Tests
      # ========================================
      - name: üöÄ Execute DAMS Automation
        env:
          DAMS_JWT_TOKEN: ${{ secrets.DAMS_JWT_TOKEN }}
        run: |
          echo "Starting DAMS Automation..."
          mvn exec:java -Dexec.mainClass="DamsAutomation"
        continue-on-error: false
      
      # ========================================
      # STEP 7: Upload Screenshots as Artifacts
      # ========================================
      - name: üì∏ Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ github.run_number }}
          path: reports/*.png
          retention-days: 30
          if-no-files-found: warn
      
      # ========================================
      # STEP 8: Upload HTML Reports as Artifacts
      # ========================================
      - name: üìä Upload HTML Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-reports-${{ github.run_number }}
          path: reports/*.html
          retention-days: 30
          if-no-files-found: warn
      
      # ========================================
      # STEP 9: Upload All Reports (Combined)
      # ========================================
      - name: üìÅ Upload All Reports (Combined)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dams-automation-reports-${{ github.run_number }}
          path: reports/
          retention-days: 30
          if-no-files-found: warn
      
      # ========================================
      # STEP 10: Display Execution Summary
      # ========================================
      - name: üìã Display Execution Summary
        if: always()
        run: |
          echo "================================================"
          echo "           AUTOMATION EXECUTION SUMMARY         "
          echo "================================================"
          echo "Run Number: ${{ github.run_number }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "================================================"
          
          if [ -d "reports" ]; then
            echo "üìÇ Generated Reports:"
            ls -lh reports/
          else
            echo "‚ö†Ô∏è No reports directory found"
          fi
      
      # ========================================
      # STEP 11: Notify on Failure (Optional)
      # ========================================
      - name: üö® Notify on Failure
        if: failure()
        run: |
          echo "‚ùå Automation execution FAILED!"
          echo "Please check the logs and artifacts for details."
          exit 1
