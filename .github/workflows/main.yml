name: DAMS API Automation with Report

on:
  workflow_dispatch:
    inputs:
      run_description:
        description: 'Description of this run'
        required: false
        default: 'Manual execution'
  schedule:
    - cron: '0 9 * * *'
  push:
    branches:
      - main
    paths:
      - '**/*.java'
      - '.github/workflows/**'

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

jobs:
  automation:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: â˜• Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          
      - name: ðŸ”§ Setup Chrome and ChromeDriver
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
          
      - name: ðŸ“¦ Download Selenium Dependencies
        run: |
          mkdir -p lib
          cd lib
          
          # Selenium 4.16.1 (More stable)
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-java/4.16.1/selenium-java-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-api/4.16.1/selenium-api-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-chrome-driver/4.16.1/selenium-chrome-driver-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-remote-driver/4.16.1/selenium-remote-driver-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-support/4.16.1/selenium-support-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-chromium-driver/4.16.1/selenium-chromium-driver-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-manager/4.16.1/selenium-manager-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-json/4.16.1/selenium-json-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-http/4.16.1/selenium-http-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-os/4.16.1/selenium-os-4.16.1.jar
          
          # Common Dependencies
          wget -q https://repo1.maven.org/maven2/com/google/guava/guava/32.1.3-jre/guava-32.1.3-jre.jar
          wget -q https://repo1.maven.org/maven2/com/google/guava/failureaccess/1.0.1/failureaccess-1.0.1.jar
          wget -q https://repo1.maven.org/maven2/org/asynchttpclient/async-http-client/2.12.3/async-http-client-2.12.3.jar
          wget -q https://repo1.maven.org/maven2/io/netty/netty-all/4.1.101.Final/netty-all-4.1.101.Final.jar
          wget -q https://repo1.maven.org/maven2/org/apache/commons/commons-exec/1.3/commons-exec-1.3.jar
          wget -q https://repo1.maven.org/maven2/dev/failsafe/failsafe/3.3.2/failsafe-3.3.2.jar
          wget -q https://repo1.maven.org/maven2/org/slf4j/slf4j-api/2.0.9/slf4j-api-2.0.9.jar
          wget -q https://repo1.maven.org/maven2/org/slf4j/slf4j-simple/2.0.9/slf4j-simple-2.0.9.jar
          wget -q https://repo1.maven.org/maven2/com/google/auto/service/auto-service-annotations/1.1.1/auto-service-annotations-1.1.1.jar
          wget -q https://repo1.maven.org/maven2/net/bytebuddy/byte-buddy/1.14.10/byte-buddy-1.14.10.jar
          
          echo "âœ… Downloaded JAR files"
          
      - name: ðŸ“ Create Directories
        run: |
          mkdir -p compiled
          mkdir -p test-report/screenshots
          
      - name: ðŸ—ï¸ Compile Java Code
        run: |
          echo "ðŸ”¨ Compiling..."
          # Compile TestWithApi.java from root to 'compiled' folder
          javac -cp "lib/*" -d compiled TestWithApi.java
          
      - name: ðŸš€ Run Automation Test
        id: run_test
        continue-on-error: true
        run: |
          echo "â–¶ï¸ Starting DAMS automation..."
          # Run from compiled folder, referencing lib for dependencies
          java -cp "compiled:lib/*" TestWithApi
          
      - name: ðŸ“Š Check Results
        if: always()
        run: |
          echo "## ðŸ“Š Execution Summary" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "test-report/screenshots" ]; then
            count=$(find test-report/screenshots -name "*.png" | wc -l)
            echo "- Screenshots: $count" >> $GITHUB_STEP_SUMMARY
          fi
          
          if ls test-report/DAMS_Report_*.html 1> /dev/null 2>&1; then
            echo "- Report Generated: âœ…" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Report Generated: âŒ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¦ Prepare GitHub Pages
        if: always()
        run: |
          mkdir -p github-pages-content/screenshots
          cp test-report/DAMS_Report_*.html github-pages-content/ 2>/dev/null || echo "<h1>No Report</h1>" > github-pages-content/index.html
          cp test-report/screenshots/*.png github-pages-content/screenshots/ 2>/dev/null || true

      - name: ðŸ“¤ Upload Pages Artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./github-pages-content

  deploy:
    needs: automation
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
