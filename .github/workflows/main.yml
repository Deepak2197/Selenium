name: DAMS API Automation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * *'
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  automation:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: â˜• Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          # No cache parameter - we're not using Maven/Gradle
          
      - name: ğŸ”§ Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
          
      - name: ğŸ“¦ Download Selenium Dependencies
        run: |
          mkdir -p lib
          cd lib
          echo "Downloading JARs..."
          
          # Core Selenium & Dependencies
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-java/4.16.1/selenium-java-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-api/4.16.1/selenium-api-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-chrome-driver/4.16.1/selenium-chrome-driver-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-remote-driver/4.16.1/selenium-remote-driver-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-support/4.16.1/selenium-support-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-chromium-driver/4.16.1/selenium-chromium-driver-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-manager/4.16.1/selenium-manager-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-json/4.16.1/selenium-json-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-http/4.16.1/selenium-http-4.16.1.jar
          wget -q https://repo1.maven.org/maven2/org/seleniumhq/selenium/selenium-os/4.16.1/selenium-os-4.16.1.jar
          
          # Required Dependencies
          wget -q https://repo1.maven.org/maven2/com/google/guava/guava/32.1.3-jre/guava-32.1.3-jre.jar
          wget -q https://repo1.maven.org/maven2/com/google/guava/failureaccess/1.0.1/failureaccess-1.0.1.jar
          wget -q https://repo1.maven.org/maven2/org/asynchttpclient/async-http-client/2.12.3/async-http-client-2.12.3.jar
          wget -q https://repo1.maven.org/maven2/io/netty/netty-all/4.1.101.Final/netty-all-4.1.101.Final.jar
          wget -q https://repo1.maven.org/maven2/org/apache/commons/commons-exec/1.3/commons-exec-1.3.jar
          wget -q https://repo1.maven.org/maven2/dev/failsafe/failsafe/3.3.2/failsafe-3.3.2.jar
          wget -q https://repo1.maven.org/maven2/org/slf4j/slf4j-api/2.0.9/slf4j-api-2.0.9.jar
          wget -q https://repo1.maven.org/maven2/org/slf4j/slf4j-simple/2.0.9/slf4j-simple-2.0.9.jar
          wget -q https://repo1.maven.org/maven2/com/google/auto/service/auto-service-annotations/1.1.1/auto-service-annotations-1.1.1.jar
          wget -q https://repo1.maven.org/maven2/net/bytebuddy/byte-buddy/1.14.10/byte-buddy-1.14.10.jar
          
          echo "âœ… All dependencies downloaded"
          ls -lh
          
      - name: ğŸ“ Create Directories
        run: |
          mkdir -p compiled
          mkdir -p test-report/screenshots
          echo "âœ… Directories created"
          
      - name: ğŸ—ï¸ Compile Java Code
        run: |
          echo "ğŸ”¨ Compiling TestWithApi.java..."
          javac -cp "lib/*" -d compiled TestWithApi.java
          echo "âœ… Compilation successful"
          ls -la compiled/
          
      - name: ğŸš€ Run Automation Test
        id: run_test
        continue-on-error: true
        run: |
          echo "â–¶ï¸ Starting DAMS automation..."
          java -cp "compiled:lib/*" TestWithApi
          TEST_EXIT_CODE=$?
          echo "test_exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          exit $TEST_EXIT_CODE
          
      - name: ğŸ“Š Execution Summary
        if: always()
        run: |
          echo "## ğŸ“Š Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.run_test.outputs.test_exit_code }}" == "0" ]; then
            echo "### âœ… Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Status: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if ls test-report/DAMS_Report_*.html 1> /dev/null 2>&1; then
            echo "- âœ… Report Generated" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“„ Report files:" >> $GITHUB_STEP_SUMMARY
            for file in test-report/DAMS_Report_*.html; do
              echo "  - $(basename $file)" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- âŒ No Report Found" >> $GITHUB_STEP_SUMMARY
          fi
          
          if ls test-report/screenshots/*.png 1> /dev/null 2>&1; then
            echo "- ğŸ“¸ Screenshots captured: $(ls test-report/screenshots/*.png | wc -l)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“¤ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: test-report/
          retention-days: 30
          
      - name: ğŸ¯ Final Status
        if: always()
        run: |
          if [ "${{ steps.run_test.outputs.test_exit_code }}" != "0" ]; then
            echo "âŒ Automation execution FAILED!"
            echo "Please check the logs and artifacts for details."
            exit 1
          else
            echo "âœ… Automation execution SUCCESSFUL!"
          fi
